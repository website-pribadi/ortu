<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Publik</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #d2dbdc;
      display: flex; justify-content: center; align-items: center;
    }
    .chat-box { width: 100vw; height: 100vh; background: #f8f9fa; display: flex; flex-direction: column; }
    .header {
      background: #075e54; color: white;
      padding: 14px; font-size: 18px; font-weight: bold; text-align: center;
    }
    .messages {
      flex: 1; padding: 20px; overflow-y: auto; background: #efeae2;
      display: flex; flex-direction: column;
      position: relative;
    }
    .message {
      background: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 6px 0;
      display: inline-block;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 70%;
      position: relative;
    }
    .me { align-self: flex-end; background: #dcf8c6; }
    .friend { align-self: flex-start; background: #ffffff; }
    .message small { display: block; margin-top: 6px; font-size: 12px; color: #666; text-align: left; }
    .me small { text-align: right; }
    .selected { transform: translateX(-40px); box-shadow: 0 0 6px rgba(0,0,0,0.2); }

    .input-box {
      display: flex; align-items: center;
      padding: 10px; background: #f0f0f0;
      border-top: 1px solid #ccc; flex-wrap: wrap;
    }
    .input-box input[type="text"] {
      flex: 1; padding: 12px;
      border-radius: 20px; border: none; outline: none;
    }
    .input-box button {
      margin-left: 10px; padding: 10px 20px;
      border: none; border-radius: 20px;
      background: #075e54; color: white;
      cursor: pointer;
    }
    .input-box label { margin-left: 10px; font-size: 20px; cursor: pointer; }

    #replyBox {
      display:none; padding:10px;
      background:#e0f7fa; border-left:4px solid #00796b;
      font-size: 13px;
    }
    #replyBox button {
      float:right; background:none; border:none;
      color:#00796b; cursor:pointer;
    }

    /* 🔹 Preview file di atas input box (FIX) */
    #filePreview {
      display: none; /* awalnya tersembunyi */
      background: #e0f7fa;
      border-top: 1px solid #ccc;
      border-bottom: 1px solid #ccc;
      padding: 10px 14px;
      font-size: 14px;
      color: #075e54;
      align-items: center;
      justify-content: space-between;
    }
    #filePreview span {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #filePreview button {
      background: none;
      border: none;
      color: #075e54;
      font-size: 18px;
      cursor: pointer;
      margin-left: 8px;
    }

    .context-menu {
      position: absolute;
      display: none;
      flex-direction: column;
      justify-content: space-between;
      z-index: 1000;
    }
    .context-menu button {
      width: 42px; height: 42px;
      font-size: 18px; background: white;
      border: 1px solid #ccc;
      cursor: pointer; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      transition: background 0.2s; padding: 0;
    }
    .context-menu button:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <div class="chat-box">
    <div class="header">Chat Publik</div>

    <div id="messages" class="messages"></div>

    <div id="replyBox">Membalas: <span id="replyText"></span>
      <button onclick="cancelReply()">✕</button>
    </div>

    <!-- 🔹 Preview file di atas input -->
    <div id="filePreview">
      <span id="filePreviewText"></span>
      <button onclick="clearFile()">✕</button>
    </div>

    <div class="input-box">
      <input id="messageInput" type="text" placeholder="Ketik pesan..." />
      <label for="fileInput">📎</label>
      <input type="file" id="fileInput" style="display:none;" />
      <button onclick="sendMessage()">➤</button>
    </div>
  </div>

  <div id="contextMenu" class="context-menu">
    <button title="Balas" onclick="handleReply()">➥</button>
    <button title="Edit" onclick="handleEdit()">✎</button>
    <button title="Hapus" onclick="handleDelete()">⌦</button>
  </div>

 <script>
    const supabase = window.supabase.createClient(
      "https://zawtfjszvkuudawrilqg.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphd3RmanN6dmt1dWRhd3JpbHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTk2NzMsImV4cCI6MjA3NDk5NTY3M30.CGYz4-QnYb3Hu9p3fV0XoG5J8oicqZsji-YJf2UItQ8"
    );

    let senderName = localStorage.getItem("chat_name");
    if (!senderName) {
      senderName = prompt("Masukkan nama Anda:") || "Anonim";
      localStorage.setItem("chat_name", senderName);
    }

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const fileInput = document.getElementById("fileInput");
    const filePreview = document.getElementById("filePreview");
    const filePreviewText = document.getElementById("filePreviewText");
    const menu = document.getElementById("contextMenu");

    let replyToId = null;
    let selectedMessageId = null;
    let selectedMessageText = null;
    let selectedFile = null;

    // 🔍 Tentukan ikon berdasarkan tipe file
    function getFileIcon(filename, type) {
      const lower = (filename || "").toLowerCase();
      if (type.startsWith("image/")) return "📷";
      if (type.startsWith("video/")) return "🎞️";
      if (type.startsWith("audio/")) return "🎵";
      if (lower.endsWith(".pdf")) return "📄";
      if (lower.match(/\.(doc|docx|txt|rtf)$/)) return "📝";
      if (lower.match(/\.(xls|xlsx|csv)$/)) return "📊";
      if (lower.match(/\.(zip|rar|7z)$/)) return "📦";
      return "📎";
    }

    // 🔄 Preview file di atas input
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        selectedFile = file;
        const icon = getFileIcon(file.name, file.type);
        filePreviewText.textContent = `${icon} ${file.name}`;
        filePreview.style.display = "flex"; // baru muncul setelah user pilih file
      }
    });

    function clearFile() {
      selectedFile = null;
      fileInput.value = "";
      filePreview.style.display = "none";
    }

    async function uploadFile(file) {
      const filePath = `${Date.now()}-${file.name}`;
      const { error } = await supabase.storage.from("chat-files").upload(filePath, file);
      if (error) { alert("Upload gagal"); return null; }
      const { data } = supabase.storage.from("chat-files").getPublicUrl(filePath);
      return data.publicUrl;
    }

    async function sendMessage() {
      const text = input.value.trim();
      let fileUrl = null;
      if (!text && !selectedFile) return;

      if (selectedFile) fileUrl = await uploadFile(selectedFile);

      await supabase.from("messages").insert([{
        text,
        sender: senderName,
        created_at: new Date().toISOString(),
        reply_to: replyToId,
        image_url: fileUrl,
        file_name: selectedFile ? selectedFile.name : null,
        file_type: selectedFile ? selectedFile.type : null
      }]);

      input.value = "";
      clearFile();
      cancelReply();
    }

    async function loadMessages() {
      const { data, error } = await supabase.from("messages").select("*").order("created_at", { ascending: true });
      if (error) return;
      messagesDiv.innerHTML = "";
      data.forEach(addMessageToUI);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addMessageToUI(msg) {
      if (document.getElementById("msg-" + msg.id)) return;
      const div = document.createElement("div");
      const isMe = msg.sender === senderName;
      div.className = "message " + (isMe ? "me" : "friend");
      div.id = "msg-" + msg.id;
      const time = new Date(msg.created_at).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let replyHTML = "";
      if (msg.reply_to) {
        const replied = document.getElementById("msg-" + msg.reply_to);
        const repliedTextEl = replied ? replied.querySelector(".msg-text") : null;
        const repliedText = repliedTextEl ? repliedTextEl.textContent.slice(0, 30) + '...' : "Pesan dibalas...";
        replyHTML = `<div style="background:#f0f0f0;padding:6px;border-left:3px solid #ccc;font-size:12px;margin-bottom:4px;">Membalas: ${repliedText}</div>`;
      }

      let fileHTML = "";
      if (msg.image_url) {
        const filename = msg.file_name || msg.image_url.split('/').pop();
        const icon = getFileIcon(filename, msg.file_type || "");
        fileHTML = `<a href="${msg.image_url}" target="_blank" style="display:block;margin-top:6px;color:#075e54;">${icon} ${filename}</a>`;
      }

      div.innerHTML = `
        <strong style="font-size:12px;">${msg.sender}</strong><br>
        ${replyHTML}
        <span class="msg-text">${msg.text || ""}</span>${fileHTML}
        <small>${time}</small>
      `;

      div.addEventListener("contextmenu", e => {
        e.preventDefault();
        selectedMessageId = msg.id;
        selectedMessageText = msg.text;
        document.querySelectorAll(".message").forEach(el => el.classList.remove("selected"));
        div.classList.add("selected");
        if (isMe) showContextMenuForMessage(div);
        else handleReply();
      });

      messagesDiv.appendChild(div);
    }

    function showContextMenuForMessage(messageElement) {
      const rect = messageElement.getBoundingClientRect();
      const containerRect = messagesDiv.getBoundingClientRect();
      menu.style.display = "flex";
      menu.style.height = rect.height + "px";
      const left = rect.right - containerRect.left + 6;
      const top = rect.top - containerRect.top + messagesDiv.scrollTop;
      menu.style.left = `${left}px`;
      menu.style.top = `${top}px`;
      messagesDiv.appendChild(menu);
    }

    function hideContextMenu() {
      menu.style.display = "none";
      menu.style.height = "auto";
      document.querySelectorAll(".message").forEach(el => el.classList.remove("selected"));
    }
    document.addEventListener("click", hideContextMenu);

    function handleReply() {
      document.getElementById("replyText").textContent = selectedMessageText.length > 40 ? selectedMessageText.substring(0, 40) + '...' : selectedMessageText;
      document.getElementById("replyBox").style.display = "block";
      replyToId = selectedMessageId;
      hideContextMenu();
    }
    function cancelReply() { document.getElementById("replyBox").style.display = "none"; replyToId = null; }

    async function handleEdit() {
      const newText = prompt("Edit pesan:", selectedMessageText);
      if (!newText || newText.trim() === selectedMessageText) return;
      await supabase.from("messages").update({ text: newText }).eq("id", selectedMessageId).eq("sender", senderName);
      hideContextMenu();
    }

    async function handleDelete() {
      if (confirm("Hapus pesan ini?")) {
        await supabase.from("messages").delete().eq("id", selectedMessageId).eq("sender", senderName);
      }
      hideContextMenu();
    }

    supabase.channel("public_chat")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
        addMessageToUI(payload.new);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      })
      .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, payload => {
        const el = document.getElementById("msg-" + payload.new.id);
        if (el) el.querySelector(".msg-text").textContent = payload.new.text;
      })
      .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, payload => {
        const el = document.getElementById("msg-" + payload.old.id);
        if (el) el.remove();
      })
      .subscribe();

    loadMessages();
    input.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });
  </script>
</body>
</html>
